<head>
    <meta charset='utf-8'>
    <title>QUIESTCE</title>
    <link rel='stylesheet' type='text/css' href='style/style.css'>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>



</head>
<body>
    <script>

        async function getCsv(){
            res= await fetch('joueurs.csv');
            let text=  await res.text();
            let doc = []
            let lignes = text.split("\r\n");
            const headers = lignes[0].split(",");
            for (var i = 1 ; i<lignes.length ; i++) {
                var obj = {};
                var current = lignes[i].split(",");
                for (var j = 0; j < current.length; j++) {
                    obj[headers[j]] = current[j];
                }
                doc.push(obj);
            }
            return doc
        }
        const csv = getCsv();
        const joueurDuJour = "Jude Sharp";
        const dejaVu =[];
        function VerifNom(nom,char){
            let noms = nom.split(' ');
            let chars = char.split(' ');
            if (chars.length>noms.length){
                return false
            }
            for (var x = 0;x < noms.length-(chars.length-1);x++){
                for (var y= 0 ; y < chars.length;y++){
                    if (!noms[x+y].toLowerCase().startsWith(chars[y].toLowerCase())){
                         break
                    }
                    if (y===chars.length-1){
                         return true
                     }
                }
            }
            return false;
        }
        function VerifSurnoms(surnoms,char){
            let listeSurnoms = surnoms.split('-');
            for (let surnom in listeSurnoms){

                if (VerifNom(listeSurnoms[surnom],char)){
                    return [true,listeSurnoms[surnom]];
                }
            }
            return [false];
        }

        function afficheComparaison(nom1){
            csv.then((s)=>{

                let j1;
                let j2;
                for (let joueur1 in s){
                    joueur1=s[joueur1]
                    if (joueur1['Nom']===nom1){
                        j1=joueur1;
                    }
                    if (joueur1['Nom']===joueurDuJour){
                        j2=joueur1;
                    }
                }
                dejaVu.push(j1['Nom']);
                let table = document.getElementById('comp');
                let row = table.insertRow(1);
                for (let cle in j1){
                    compare(cle,j1[cle],j2[cle],row);
                }
                console.log(j1['Nom']+" vs "+j2['Nom'])
            })
        }

        function compare(cle,val1,val2,row){
            if (["Photo","Genre","Equipe","Poste","Element","Origine","Classe","Apparition"].includes(cle)){
                let td = document.createElement('td');
                if (cle==="Photo"){
                    let img = document.createElement('img');
                    img.setAttribute('src','images/personnages/'+val1)
                    img.setAttribute('class','photo_comp');
                    img.setAttribute('alt','photo');
                    td.appendChild(img);
                }
                else {
                    td.appendChild(document.createTextNode(val1))
                    if(cle==="Genre" || cle==="Element"){
                        if (val1===val2){
                            td.style.backgroundColor= 'green'
                        }
                        else{
                            td.style.backgroundColor = 'red';
                        }
                    }
                    else if (["Poste","Origine","Equipe"].includes(cle)){
                        let nb= 0;
                        let eq1= val1.split('-');
                        let eq2 = val2.split('-');
                        for (let eq in eq1){
                            eq = eq1[eq];
                            if (eq2.includes(eq)){
                                nb++;
                            }
                        }
                        if(nb===0){
                            td.style.backgroundColor = 'red';
                        }

                        else if (nb===eq2.length && nb===eq1.length){
                            td.style.backgroundColor = 'green';
                        }
                        else{
                            td.style.backgroundColor = 'orange';
                        }
                    }
                    else if(["Classe","Apparition"].includes(cle)){
                        if (val1===val2){
                            td.style.backgroundColor = 'green';
                        }
                        else{
                            td.style.backgroundColor = 'red';
                            if (cle==='Apparition'){
                                if (val1!=='Film'){
                                    let j1Saison = val1.split(' ')[1];
                                    let j2Saison = val2.split(' ')[1];
                                    if (parseInt(j1Saison)>parseInt(j2Saison)){
                                        let fleche = document.createElement('div');
                                        fleche.setAttribute('class','inf');
                                        td.appendChild(fleche)
                                    }
                                    else{
                                        let fleche = document.createElement('div');
                                        fleche.setAttribute('class','sup');
                                        td.appendChild(fleche)
                                    }
                                }
                            }
                            else{
                                let listeClasse = ["CM2","6e","5e","4e","3e","Adulte"];
                                if (val1!=='Inconnue' && val2!=='Inconnue'){
                                    let index1 = listeClasse.indexOf(val1);
                                    let index2 = listeClasse.indexOf(val2);
                                    if (index1>index2){
                                        let fleche = document.createElement('div');
                                        fleche.setAttribute('class','inf');
                                        td.appendChild(fleche)
                                    }
                                    else{
                                        let fleche = document.createElement('div');
                                        fleche.setAttribute('class','sup');
                                        td.appendChild(fleche)
                                    }
                                }
                            }
                        }
                    }
                }
                row.appendChild(td);
            }


        }
        var precedent;
        function afficherPersos(){
            var ancien = document.getElementById('liste_carte');
            let nom = document.getElementById('guess').value;
            if (nom===precedent){
                return
            }
            else{
                precedent=nom
            }
            if (ancien){
                ancien.remove();
            }
            if (nom===""){
                return
            }

            let racine = document.getElementById('racine');
            let div = document.createElement('div');
            div.setAttribute('id','liste_carte');
            let table = document.createElement('table');
            table.setAttribute('id','table_carte')
            csv.then((s)=>{
                let vide = true;
                for (let joueur in s){
                    joueur = s[joueur]
                    verifsurnom = VerifSurnoms(joueur['Surnoms'],nom)
                    if ((VerifNom(joueur['Nom'],nom) || verifsurnom[0]) && !dejaVu.includes(joueur["Nom"])){
                        let tr = document.createElement('tr');
                        let td = document.createElement('td');
                        td.setAttribute('class','row');
                        td.setAttribute('id',joueur["Nom"].replace(' ',''));
                        if(vide){
                            td.classList.add('selected')
                        }
                        let carte = document.createElement('div');
                        carte.setAttribute('class','carte');
                        carte.setAttribute('name',joueur['Nom']);
                        carte.setAttribute('onclick','afficheComparaison("'+joueur["Nom"]+'")');
                        let img = document.createElement('img');
                        img.setAttribute('src','images/personnages/'+joueur["Photo"]);
                        img.setAttribute('alt','photoperso');
                        img.setAttribute('class','photo_carte');
                        carte.appendChild(img);
                        let p = document.createElement('p');
                        let texte = document.createTextNode(joueur['Nom']);
                        p.appendChild(texte);
                        if (verifsurnom[0]){
                            let surnom = document.createElement('p');
                            surnom.style.fontSize = "12px"
                            let texte2 = document.createTextNode('Alias : '+verifsurnom[1]);
                            surnom.appendChild(texte2);
                            let div = document.createElement('div');
                            surnom.setAttribute('class','surnom');
                            div.setAttribute('class','nomcontain');
                            div.appendChild(p);
                            div.appendChild(surnom);
                            carte.appendChild(div);

                        }
                        else{
                            carte.appendChild(p);
                        }
                        td.appendChild(carte);
                        tr.appendChild(td);
                        table.appendChild(tr);
                        vide = false;
                    }
                }
                if (vide){
                    let tr = document.createElement('tr');
                    let td = document.createElement('td');
                    td.setAttribute('id','vide');
                    let p = document.createElement('p');
                    let texte = document.createTextNode("Aucun personnage n'a été trouvé.");
                    p.appendChild(texte);
                    td.appendChild(p);
                    tr.appendChild(td);
                    table.appendChild(tr);
                }
                div.appendChild(table);
                racine.appendChild(div);
            })
        }

    </script>
    <div>
        <h1>Devinez le personnage d'inazuma d'aujourd'hui</h1>
    </div>
    <div id="racine">
        <form method='post' action='' id='formulaire'>
            <input type='text' name='guess' id='guess' placeholder='Nom de personnage, alias'
                   onkeyup='afficherPersos()'>
            <input type='submit' value='Envoyer'>
        </form>
    </div>
    <script>
        let text = document.getElementById('guess')
        text.addEventListener('keydown',reaction)
        function reaction(e){
            if (e.code==="ArrowDown" || e.code==="ArrowUp"){
                e.preventDefault();
            }
        }

    </script>
    <table id="comp">
        <tr>
            <th>Perso</th>
            <th>Genre</th>
            <th>Equipes</th>
            <th>Poste</th>
            <th>Element</th>
            <th>Origine</th>
            <th>Classe</th>
            <th>Apparition</th>
        </tr>
    </table>


    <script>
        let body = document.getElementsByTagName('body')[0];
        body.addEventListener("keyup",parcourir);

        function parcourir(e){
            let table = document.getElementById('table_carte');
            if (table && table.rows.length>=2 ){
                let index;
                let td = document.getElementsByClassName('selected')[0];
                if (e.code==="ArrowDown" || e.code==="ArrowUp"){
                    if (e.code==="ArrowDown"){
                        index = (td.parentElement.rowIndex+1)%table.rows.length

                    }
                    else{
                        index = td.parentElement.rowIndex-1
                        if (index<0){
                            index = table.rows.length+index
                        }

                    }
                    let newSelected = table.rows[index % table.rows.length].children[0]
                    td.classList.remove('selected')
                    newSelected.classList.add('selected')
                    console.log(td.id+" "+td.classList+" " +newSelected.id+newSelected.classList)
                }

            }

        }
    </script>
</body>