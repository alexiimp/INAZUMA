<head>
    <meta charset='utf-8'>
    <title>QUIESTCE</title>
    <link rel='stylesheet' type='text/css' href='style/style.css'>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>



</head>
<body>
    <script>

        async function getCsv(){
            res= await fetch('joueurs.csv');
            let text=  await res.text();
            let doc = []
            let lignes = text.split("\r\n");
            let headers = lignes[0].split(",");
            for (var i = 1 ; i<lignes.length ; i++) {
                var obj = {};
                var current = lignes[i].split(",");
                for (var j = 0; j < current.length; j++) {
                    obj[headers[j]] = current[j];
                }
                doc.push(obj);
            }
            return doc
        }
        const csv = getCsv();

        function VerifNom(nom,char){
            let noms = nom.split(' ');
            let chars = char.split(' ');
            if (chars.length>noms.length){
                return false
            }
            for (var x = 0;x < noms.length-(chars.length-1);x++){
                for (var y= 0 ; y < chars.length;y++){
                    if (!noms[x+y].toLowerCase().startsWith(chars[y].toLowerCase())){
                         break
                    }
                    if (y===chars.length-1){
                         return true
                     }
                }
            }
            return false;
        }
        function VerifSurnoms(surnoms,char){
            let listeSurnoms = surnoms.split('-');
            for (let surnom in listeSurnoms){

                if (VerifNom(listeSurnoms[surnom],char)){
                    return [true,listeSurnoms[surnom]];
                }
            }
            return [false];
        }

        function comparaison(nom1){
            csv.then((s)=>{

                let j1;
                let j2;
                for (let joueur1 in s){
                    joueur1=s[joueur1]
                    if (joueur1['Nom']===nom1){
                        j1=joueur1;
                    }
                    if (joueur1['Nom']==="Jude Sharp"){
                        j2=joueur1;
                    }
                }
                console.log(j1['Nom']+" vs "+j2['Nom'])
            })
        }
        function afficherPersos(){
            var ancien = document.getElementById('liste_carte');
            const nom = document.getElementById('guess').value;
            if (ancien){
                ancien.remove();
            }
            if (nom===""){
                return
            }

            let body = document.getElementsByTagName('body')[0];
            let div = document.createElement('div');
            div.setAttribute('id','liste_carte');
            let table = document.createElement('table');
            csv.then((s)=>{
                let vide = true;
                for (let joueur in s){
                    joueur = s[joueur]
                    verifsurnom = VerifSurnoms(joueur['Surnoms'],nom)
                    if (VerifNom(joueur['Nom'],nom) || verifsurnom[0]){
                        vide = false;
                        let tr = document.createElement('tr');
                        let td = document.createElement('td');
                        td.setAttribute('id',joueur["Nom"]);
                        let carte = document.createElement('div');
                        carte.setAttribute('id','carte');
                        carte.setAttribute('name',joueur['Nom']);
                        carte.setAttribute('onclick','comparaison("'+joueur["Nom"]+'")');

                        let img = document.createElement('img');
                        img.setAttribute('src','images/personnages/'+joueur["Photo"]);
                        img.setAttribute('alt','photoperso');
                        img.setAttribute('id','photo_carte');
                        carte.appendChild(img);
                        let p = document.createElement('p');
                        let texte = document.createTextNode(joueur['Nom']);
                        p.appendChild(texte);
                        if (verifsurnom[0]){
                            let surnom = document.createElement('p');
                            surnom.style.fontSize = "12px"
                            let texte2 = document.createTextNode('Alias : '+verifsurnom[1]);
                            surnom.appendChild(texte2);
                            let div = document.createElement('div');
                            surnom.setAttribute('id','surnom');
                            div.setAttribute('id','nomcontain');
                            div.appendChild(p);
                            div.appendChild(surnom);
                            carte.appendChild(div);

                        }
                        else{
                            carte.appendChild(p);
                        }
                        td.appendChild(carte);
                        tr.appendChild(td);
                        table.appendChild(tr);
                    }
                }
                if (vide){
                    let tr = document.createElement('tr');
                    let td = document.createElement('td');
                    td.setAttribute('id','vide');
                    let p = document.createElement('p');
                    let texte = document.createTextNode("Aucun personnage n'a été trouvé.");
                    p.appendChild(texte);
                    td.appendChild(p);
                    tr.appendChild(td);
                    table.appendChild(tr);
                }
                div.appendChild(table);
                body.appendChild(div);
            })
        }

    </script>
    <div>
        <h1>Devinez le personnage d'inazuma d'aujourd'hui</h1>
    </div>
    <form method='post' action='' id='formulaire'>
        <input type='text' name='guess' id='guess' placeholder='Nom de personnage, alias' onkeyup='afficherPersos()'>
        <input type='submit' value='Envoyer'>
    </form>
</body>